stages:
  - image
  - test
  - integration
  - build
  - publish

#############
# templates #
#############
.job:
  image: $CI_REGISTRY/linaro/tuxrun/ci
  script:
  - make $CI_JOB_NAME

######
# CI #
######
ci-image:
  stage: image
  image: docker:20.10-dind
  services:
  - name: docker:20.10-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
  - 'docker build -t $CI_REGISTRY/linaro/tuxrun/ci -f Dockerfile.ci .'
  - 'docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY'
  - 'docker push $CI_REGISTRY/linaro/tuxrun/ci'
  only:
    refs:
    - master
    changes:
    - Dockerfile.ci

ci-image-integration:
  stage: image
  image: docker:20.10-dind
  services:
  - name: docker:20.10-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
  - 'docker build -t $CI_REGISTRY/linaro/tuxrun/ci-integration -f Dockerfile.ci-integration .'
  - 'docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY'
  - 'docker push $CI_REGISTRY/linaro/tuxrun/ci-integration'
  only:
    refs:
    - master
    changes:
    - Dockerfile.ci-integration

########
# test #
########
unit-tests:
  extends: .job
  stage: test
  coverage: '/Total coverage: (\d+\.\d+)%$/'

stylecheck:
  extends: .job
  stage: test

typecheck:
  extends: .job
  stage: test

spellcheck:
  extends: .job
  stage: test

###############
# integration #
###############
integration:
  extends: .job
  image: $CI_REGISTRY/linaro/tuxrun/ci-integration
  stage: integration
  script:
  - PYTHONPATH=. python3 test/integration.py --runtime null --device $DEVICE --tests $TEST
  parallel:
    matrix:
    - DEVICE:
      - qemu-armv5
      - qemu-armv7
      - qemu-arm64
      - qemu-i386
      - qemu-mips64
      - qemu-mips64el
      - qemu-ppc32
      - qemu-ppc64
      - qemu-ppc64le
      - qemu-sparc64
      - qemu-x86_64
      TEST:
      - ltp-fcntl-locktests ltp-fsx ltp-fs_perms_simple ltp-smoke
      - ltp-fs_bind
      - ltp-nptl
    # FIXME ltp-nptl takes forever on qemu-mips32(el) and qemu-riscv64; ignore that jobs for now
    - DEVICE:
      - qemu-mips32
      - qemu-mips32el
      - qemu-riscv64
      TEST:
      - ltp-fcntl-locktests ltp-fsx ltp-fs_perms_simple ltp-smoke
      - ltp-fs_bind

#########
# Build #
#########
doc:
  extends: .job
  stage: build
  artifacts:
    paths:
      - public
  before_script:
    - python3 -m pip install mkdocs-material  # FIXME not in Debian

###########
# publish #
###########
pages:
  extends: .job
  stage: publish
  needs:
    - doc
  artifacts:
    paths:
      - public
  only:
    - tags
  script:
    - 'true' # nothing to do

publish-pypi:
  extends: .job
  stage: publish
  only:
    - tags
